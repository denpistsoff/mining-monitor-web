name: Deploy React App to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Create auth credentials
        run: |
          mkdir -p public/data/auth
          AUTH_JSON='${{ secrets.AUTH_CREDENTIALS }}'
          echo "$AUTH_JSON" > public/data/auth/credentials.json
          echo "✅ Auth file created"

      - name: Process farm data files
        run: |
          mkdir -p public/data
          # Копируем и обрабатываем все farm_data_*.json файлы
          for file in data/farm_data_*.json; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              farm_name="${filename#farm_data_}"
              farm_name="${farm_name%.json}"
              echo "Processing farm: $farm_name"
          
              # Обрабатываем JSON структуру
              node -e "
              const fs = require('fs');
              const originalData = JSON.parse(fs.readFileSync('$file', 'utf8'));
              const containers = originalData.containers || {};
              const containerEntries = Object.entries(containers);
          
              const summary = {
                total_containers: containerEntries.length,
                total_miners: containerEntries.reduce((sum, [_, container]) => sum + (container.total_miners || 0), 0),
                online_miners: containerEntries.reduce((sum, [_, container]) => sum + (container.online_miners || 0), 0),
                total_hashrate: containerEntries.reduce((sum, [_, container]) => sum + (container.total_hashrate || 0), 0),
                total_power: containerEntries.reduce((sum, [_, container]) => sum + (container.total_power || 0), 0)
              };
          
              const processedContainers = {};
              containerEntries.forEach(([containerId, container]) => {
                processedContainers[containerId] = {
                  stats: {
                    total_hashrate: container.total_hashrate,
                    total_power: container.total_power
                  },
                  miners: container.miners_data || []
                };
              });
          
              const processedData = {
                ...originalData,
                summary: summary,
                containers: processedContainers
              };
          
              fs.writeFileSync('public/data/farm_data_$farm_name.json', JSON.stringify(processedData, null, 2));
              "
            fi
          done
          
          # Создаем индекс ферм
          node -e "
          const fs = require('fs');
          const farms = [];
          
          fs.readdirSync('data').forEach(file => {
            if (file.startsWith('farm_data_') && file.endsWith('.json')) {
              const farmName = file.replace('farm_data_', '').replace('.json', '');
              farms.push({
                name: farmName,
                file: file
              });
            }
          });
          
          fs.writeFileSync('public/data/farms_index.json', JSON.stringify({ farms }, null, 2));
          console.log('✅ Farms index created with', farms.length, 'farms');
          "

      - name: Build React app
        run: npm run build

      - name: Copy data to build
        run: |
          mkdir -p build/data
          cp -r public/data/* build/data/
          touch build/.nojekyll
          echo "✅ Build files prepared"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./build

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
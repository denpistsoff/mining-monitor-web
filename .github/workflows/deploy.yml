name: Deploy Mining Monitor to GitHub Pages

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

# Ð’Ð°Ð¶Ð½Ð¾! Ð”Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ð·Ð°Ð¿Ð¸ÑÑŒ
permissions:
  contents: write
  pages: write
  id-token: write
  actions: read

env:
  NODE_VERSION: '18'
  APP_VERSION: '5.0.0'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: github-pages
    
    steps:
      # Ð’Ð°Ð¶Ð½Ð¾! Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ GITHUB_TOKEN Ð´Ð»Ñ Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½, Ð° Ð½Ðµ GH_TOKEN
          persist-credentials: true
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --silent || npm install --silent
          echo "âœ… Dependencies installed"

      - name: Create public directories
        run: |
          mkdir -p public/data/history
          mkdir -p public/config
          echo "âœ… Directories created"

      - name: Download frontend config
        run: |
          echo "ðŸ“¥ Downloading frontend config..."
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ GITHUB_TOKEN Ð´Ð»Ñ API Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3.raw" \
               -o public/frontend_config.json \
               https://api.github.com/repos/${{ github.repository }}/contents/data/frontend_config.json || \
          echo '{"users":[],"farms":[],"user_farm_assignments":{},"version":"5.0"}' > public/frontend_config.json
          
          if [ -f public/frontend_config.json ]; then
            echo "âœ… Config downloaded: $(wc -l < public/frontend_config.json) lines"
          fi

      - name: Download history files
        run: |
          echo "ðŸ“Š Downloading history files..."
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ ÑÐ¿Ð¸ÑÐºÐ°
          TEMP_LIST=$(mktemp)
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ñ„Ð°Ð¹Ð»Ð¾Ð² Ñ‡ÐµÑ€ÐµÐ· API
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               "https://api.github.com/repos/${{ github.repository }}/contents/data/" > $TEMP_LIST
          
          # ÐŸÐ°Ñ€ÑÐ¸Ð¼ JSON Ð¸ ÑÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ history Ñ„Ð°Ð¹Ð»
          grep -o '"name":"history_[^"]*\.json"' $TEMP_LIST | cut -d'"' -f4 | while read file; do
            if [ ! -z "$file" ]; then
              echo "  ðŸ“¥ Downloading $file..."
              curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                   -H "Accept: application/vnd.github.v3.raw" \
                   -o "public/data/history/$file" \
                   "https://api.github.com/repos/${{ github.repository }}/contents/data/$file"
            fi
          done
          
          rm $TEMP_LIST
          
          # Ð¡Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼ ÑÐºÐ°Ñ‡Ð°Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          if [ -d public/data/history ]; then
            COUNT=$(ls -1 public/data/history/*.json 2>/dev/null | wc -l)
            echo "âœ… Downloaded $COUNT history files"
          fi

      - name: Build React app
        run: |
          echo "ðŸ”¨ Building React app..."
          CI=false GENERATE_SOURCEMAP=false npm run build
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¸ Ð² build
          if [ -f public/frontend_config.json ]; then
            cp public/frontend_config.json build/
            echo "âœ… Config copied to build"
          fi
          
          if [ -d public/data/history ]; then
            mkdir -p build/data/history
            cp -r public/data/history/* build/data/history/ 2>/dev/null || true
            echo "âœ… History copied to build"
          fi
          
          echo "âœ… Build completed"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './build'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment info
        run: |
          echo "ðŸŽ‰ Deployment successful!"
          echo "ðŸ“… Time: $(date)"
          echo "ðŸ”— URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ðŸ“¦ Version: ${{ env.APP_VERSION }}"
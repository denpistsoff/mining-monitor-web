name: Deploy React App to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm install
        
      - name: Download and debug farm data
        run: |
          mkdir -p public/data
          echo "üîç Downloading farm data..."
          
          # –°–∫–∞—á–∏–≤–∞–µ–º —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–æ–º
          curl -v -s -o public/data/raw_data.json "https://raw.githubusercontent.com/denpistsoff/mining-monitor/main/data/farm_data.json" 2> curl_log.txt
          
          echo "=== CURL LOG ==="
          cat curl_log.txt
          
          echo "=== DOWNLOADED CONTENT (first 500 chars) ==="
          head -c 500 public/data/raw_data.json
          echo ""
          
          echo "=== FILE INFO ==="
          file public/data/raw_data.json
          ls -la public/data/raw_data.json
          
          # –ü—Ä–æ–±—É–µ–º –ø–æ—á–∏–Ω–∏—Ç—å JSON –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          echo "=== ATTEMPTING TO FIX JSON ==="
          python3 -c "
import json
import re

try:
    with open('public/data/raw_data.json', 'r') as f:
        content = f.read().strip()
    
    print('Original content length:', len(content))
    print('First 200 chars:', content[:200])
    
    # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –º–µ—Ç–æ–¥—ã –æ—á–∏—Å—Ç–∫–∏
    cleaned_content = content
    
    # –£–±–∏—Ä–∞–µ–º BOM –µ—Å–ª–∏ –µ—Å—Ç—å
    if content.startswith('\ufeff'):
        cleaned_content = content[1:]
        print('Removed BOM')
    
    # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ/–∫–æ–Ω—Ü–µ
    cleaned_content = cleaned_content.strip()
    
    # –ü—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å
    data = json.loads(cleaned_content)
    print('‚úÖ JSON parsed successfully after cleaning')
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∏—Å—Ç—ã–π JSON
    with open('public/data/farm_data.json', 'w') as f:
        json.dump(data, f, indent=2)
        
except json.JSONDecodeError as e:
    print(f'‚ùå JSON decode error: {e}')
    print('Trying to find JSON in response...')
    
    # –ò—â–µ–º JSON –≤ HTML –∏–ª–∏ –¥—Ä—É–≥–æ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–º
    json_match = re.search(r'\{.*\}', content, re.DOTALL)
    if json_match:
        print('Found potential JSON in response')
        try:
            data = json.loads(json_match.group())
            print('‚úÖ Extracted JSON successfully')
            with open('public/data/farm_data.json', 'w') as f:
                json.dump(data, f, indent=2)
        except:
            print('Failed to parse extracted JSON')
            # –°–æ–∑–¥–∞–µ–º fallback
            raise
    else:
        print('No JSON found in response')
        raise
except Exception as e:
    print(f'‚ùå Other error: {e}')
    # –°–æ–∑–¥–∞–µ–º fallback –¥–∞–Ω–Ω—ã–µ
    fallback = {
        'farm_name': 'Fallback Farm - Download Failed',
        'last_update': '2024-01-01T00:00:00',
        'summary': {'total_containers': 0, 'total_miners': 0, 'online_miners': 0, 'total_hashrate': 0, 'total_power': 0},
        'containers': {}
    }
    with open('public/data/farm_data.json', 'w') as f:
        json.dump(fallback, f, indent=2)
    print('‚úÖ Created fallback data')
"
        
      - name: Build React app
        run: npm run build
        
      - name: Copy data to build
        run: |
          mkdir -p build/data
          cp public/data/farm_data.json build/data/
          touch build/.nojekyll
        
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./build

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
name: Deploy React App to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Create environment file with GitHub Token
        run: |
          echo "REACT_APP_GITHUB_TOKEN=${{ secrets.GH_TOKEN }}" > .env
          echo "REACT_APP_GITHUB_REPO=denpistsoff/mining-monitor-web" >> .env
          echo "REACT_APP_VERSION=5.0" >> .env
          echo "‚úÖ Environment file created"

      - name: Download latest frontend config from data branch
        run: |
          echo "üì• Downloading frontend config from GitHub..."
          # –°–∫–∞—á–∏–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
          curl -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
               -H "Accept: application/vnd.github.v3.raw" \
               -o public/frontend_config.json \
               https://api.github.com/repos/denpistsoff/mining-monitor-web/contents/data/frontend_config.json
          
          if [ -f public/frontend_config.json ]; then
            echo "‚úÖ frontend_config.json downloaded"
            echo "File size: $(wc -l < public/frontend_config.json) lines"
          else
            echo "‚ö†Ô∏è frontend_config.json not found, using fallback"
            # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –∫–æ–Ω—Ñ–∏–≥ –µ—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç
            echo '{"users":[],"farms":[],"user_farm_assignments":{},"version":"5.0"}' > public/frontend_config.json
          fi

      - name: Download history files for all farms
        run: |
          echo "üìä Downloading history files..."
          mkdir -p public/data/history
          
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö history —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ GitHub API
          HISTORY_FILES=$(curl -s -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            https://api.github.com/repos/denpistsoff/mining-monitor-web/contents/data/ | \
            grep -o '"name":"history_[^"]*\.json"' | cut -d'"' -f4)
          
          # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
          if [ ! -z "$HISTORY_FILES" ]; then
            echo "$HISTORY_FILES" | while IFS= read -r file; do
              if [ ! -z "$file" ]; then
                echo "  üì• Downloading $file..."
                curl -s -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
                     -H "Accept: application/vnd.github.v3.raw" \
                     -o "public/data/history/$file" \
                     "https://api.github.com/repos/denpistsoff/mining-monitor-web/contents/data/$file"
              fi
            done
          fi
          
          echo "‚úÖ History files downloaded: $(ls public/data/history/ | wc -l) files"

      - name: Build React app
        run: |
          echo "üèóÔ∏è Building React app..."
          CI=false npm run build
          echo "‚úÖ Build completed"

      - name: Copy config files to build
        run: |
          echo "üìã Copying configuration files to build..."
          
          # –ö–æ–ø–∏—Ä—É–µ–º frontend_config –≤ build
          if [ -f public/frontend_config.json ]; then
            cp public/frontend_config.json build/frontend_config.json
            echo "  ‚úÖ frontend_config.json copied"
          fi
          
          # –ö–æ–ø–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é
          if [ -d public/data/history ]; then
            mkdir -p build/data/history
            cp public/data/history/*.json build/data/history/ 2>/dev/null || true
            echo "  ‚úÖ History files copied: $(ls build/data/history/ | wc -l) files"
          fi
          
          # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–±–æ—Ä–∫–µ
          cat > build/build-info.json << EOF
  {
    "version": "5.0",
    "buildDate": "$(date -Iseconds)",
    "commit": "$(git rev-parse --short HEAD)",
    "multiUser": true,
    "authType": "config-based"
  }
  EOF
  echo "  ‚úÖ Build info created"

- name: Setup Pages
  uses: actions/configure-pages@v4

- name: Upload artifact
  uses: actions/upload-pages-artifact@v3
  with:
    path: ./build

deploy:
  environment:
    name: github-pages
    url: ${{ steps.deployment.outputs.page_url }}
  runs-on: ubuntu-latest
  needs: build
  steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

# –û—Ç–¥–µ–ª—å–Ω—ã–π workflow –¥–ª—è –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
auto-update-history:
  runs-on: ubuntu-latest
  if: github.ref == 'refs/heads/main'
  needs: deploy
  
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0

    - name: Setup Git config
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"

    - name: Check for new history files
      run: |
        echo "üîç Checking for new history files..."
        
        # –°–∫–∞—á–∏–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–∑ data branch
        mkdir -p temp_history
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö history —Ñ–∞–π–ª–æ–≤
        HISTORY_FILES=$(curl -s -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
          https://api.github.com/repos/denpistsoff/mining-monitor-web/contents/data/ | \
          grep -o '"name":"history_[^"]*\.json"' | cut -d'"' -f4)
        
        CHANGES_DETECTED=false
        
        # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
        if [ ! -z "$HISTORY_FILES" ]; then
          echo "$HISTORY_FILES" | while IFS= read -r file; do
            if [ ! -z "$file" ]; then
              # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
              curl -s -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
                   -o "temp_history/$file" \
                   "https://raw.githubusercontent.com/denpistsoff/mining-monitor-web/main/data/$file"
        
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
              if [ -f "data/$file" ]; then
                if ! cmp -s "data/$file" "temp_history/$file"; then
                  echo "  üìù Changes detected in $file"
                  cp "temp_history/$file" "data/$file"
                  git add "data/$file"
                  CHANGES_DETECTED=true
                fi
              else
                echo "  üÜï New file detected: $file"
                cp "temp_history/$file" "data/$file"
                git add "data/$file"
                CHANGES_DETECTED=true
              fi
            fi
          done
        fi
        
        echo "changes_detected=$CHANGES_DETECTED" >> $GITHUB_ENV

    - name: Commit and push if changes detected
      if: env.changes_detected == 'true'
      run: |
        git commit -m "ü§ñ Auto-update farm history: $(date +'%Y-%m-%d %H:%M')"
        git push
        echo "‚úÖ History changes committed"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ñ–∏–≥–∞
validate-config:
  runs-on: ubuntu-latest
  needs: deploy
  if: always()
  
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_TOKEN }}

    - name: Validate frontend config
      run: |
        echo "üîç Validating frontend_config.json..."
        
        if [ ! -f data/frontend_config.json ]; then
          echo "‚ö†Ô∏è frontend_config.json not found!"
          exit 0
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É JSON
        if ! jq empty data/frontend_config.json 2>/dev/null; then
          echo "‚ùå Invalid JSON in frontend_config.json!"
          exit 1
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
        HAS_USERS=$(jq '.users | length' data/frontend_config.json)
        HAS_FARMS=$(jq '.farms | length' data/frontend_config.json)
        HAS_VERSION=$(jq '.version' data/frontend_config.json)
        
        echo "  ‚úÖ Users: $HAS_USERS"
        echo "  ‚úÖ Farms: $HAS_FARMS"
        echo "  ‚úÖ Version: $HAS_VERSION"
        
        echo "‚úÖ Config validation passed"
name: Deploy React App to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Create environment file with GitHub Token
        run: |
          echo "REACT_APP_GITHUB_TOKEN=${{ secrets.GH_TOKEN }}" > .env
          echo "REACT_APP_GITHUB_REPO=denpistsoff/mining-monitor-web" >> .env
          echo "Building with GitHub Token: ${#REACT_APP_GITHUB_TOKEN} characters"

      - name: Build React app
        run: npm run build

      - name: Create auth credentials from secret
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ð² ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¸
          mkdir -p build/data/auth
          
          # Ð—Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· ÑÐµÐºÑ€ÐµÑ‚Ð° Ð² credentials.json
          echo '${{ secrets.AUTH_CREDENTIALS }}' > build/data/auth/credentials.json
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½
          echo "Auth credentials file created:"
          ls -la build/data/auth/
          echo "File content:"
          cat build/data/auth/credentials.json

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./build

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  auto-commit-history:
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Setup Git config
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Check for history file changes
        id: check_changes
        run: |
          echo "Checking for history file changes..."
          if git status --porcelain | grep -q "data/farm_history.json"; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "Changes detected in farm_history.json"
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "No changes in farm_history.json"
          fi

      - name: Commit and push if changes detected
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          git add data/farm_history.json
          git commit -m "ðŸ¤– Auto-update farm history: $(date +'%Y-%m-%d %H:%M')"
          git push
          echo "âœ… History changes committed"
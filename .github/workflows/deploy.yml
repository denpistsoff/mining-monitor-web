name: Deploy React App to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Create environment file with GitHub Token
        run: |
          echo "REACT_APP_GITHUB_TOKEN=${{ secrets.GH_TOKEN }}" > .env
          echo "REACT_APP_GITHUB_REPO=denpistsoff/mining-monitor-web" >> .env
          echo "Building with GitHub Token: ${#REACT_APP_GITHUB_TOKEN} characters"

      - name: Build React app
        run: npm run build

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./build

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ÐÐ¾Ð²Ñ‹Ð¹ job Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð° Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸
  auto-commit-history:
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Setup Git config
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Check for history file changes
        id: check_changes
        run: |
          echo "Checking for history file changes..."
          if git status --porcelain | grep -q "data/farm_history.json"; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "Changes detected in farm_history.json"
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "No changes in farm_history.json"
          fi

      - name: Commit and push if changes detected
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          git add data/farm_history.json
          git commit -m "ðŸ¤– Auto-update farm history: $(date +'%Y-%m-%d %H:%M')"
          git push
          echo "âœ… History changes committed"
name: Deploy Mining Monitor to GitHub Pages

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'  # –ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç

permissions:
  contents: write
  pages: write
  id-token: write
  actions: read

env:
  NODE_VERSION: '18'
  APP_VERSION: '5.0.0'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: github-pages
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --silent || npm install --silent
          echo "‚úÖ Dependencies installed"

      - name: Create public directories
        run: |
          mkdir -p public/data/history
          mkdir -p public/config
          echo "‚úÖ Directories created"

      # ===== –ù–û–í–´–ô –®–ê–ì: –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π =====
      - name: Purge GitHub cache
        run: |
          echo "üßπ –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ GitHub..."
          
          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—Ä–æ—Å—ã –∫ raw
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -X GET "https://api.github.com/repos/${{ github.repository }}/git/refs/heads/main" > /dev/null
          
          # –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ raw —Ñ–∞–π–ª–∞–º —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫—ç—à–∞
          curl -s "https://raw.githubusercontent.com/${{ github.repository }}/main/data/frontend_config.json?cache_bust=$(date +%s)" > /dev/null
          
          echo "‚úÖ –ö—ç—à –æ—á–∏—â–µ–Ω"

      # ===== –ù–û–í–´–ô –®–ê–ì: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ =====
      - name: Check files existence
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–æ–≤ –≤ data/..."
          
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ API
          FILES=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                      "https://api.github.com/repos/${{ github.repository }}/contents/data/" | \
                      grep -o '"name":"[^"]*"' | cut -d'"' -f4)
          
          echo "üìã –ù–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã:"
          echo "$FILES" | while read file; do
            echo "   - $file"
          done
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –≤ —Ñ–∞–π–ª –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–±–æ—Ä–∫–µ
          echo "$FILES" > public/available_files.txt

      - name: Download frontend config
        run: |
          echo "üì• Downloading frontend config..."
          
          # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ URL –¥–ª—è –æ–±—Ö–æ–¥–∞ –∫—ç—à–∞
          CACHE_BUSTER=$(date +%s)_$RANDOM
          
          # –í–∞—Ä–∏–∞–Ω—Ç 1: GitHub API (–Ω–∞–¥–µ–∂–Ω–æ, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–æ)
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3.raw" \
               -o public/frontend_config.json \
               "https://api.github.com/repos/${{ github.repository }}/contents/data/frontend_config.json?ref=main&cache=$CACHE_BUSTER" || \
          
          # –í–∞—Ä–∏–∞–Ω—Ç 2: Raw GitHub —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
          curl -s -H "Cache-Control: no-cache" \
               -o public/frontend_config.json \
               "https://raw.githubusercontent.com/${{ github.repository }}/main/data/frontend_config.json?nocache=$CACHE_BUSTER" || \
          
          # –í–∞—Ä–∏–∞–Ω—Ç 3: jsDelivr CDN (–∏–Ω–æ–≥–¥–∞ –ª—É—á—à–µ –∫—ç—à–∏—Ä—É–µ—Ç)
          curl -s -o public/frontend_config.json \
               "https://cdn.jsdelivr.net/gh/${{ github.repository }}@main/data/frontend_config.json?t=$CACHE_BUSTER" || \
          
          # –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–∞–ª–∏–ª–æ—Å—å - —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π
          echo '{"users":[],"farms":[],"user_farm_assignments":{},"version":"5.0"}' > public/frontend_config.json
          
          if [ -f public/frontend_config.json ]; then
            echo "‚úÖ Config downloaded: $(wc -l < public/frontend_config.json) lines"
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            echo "üìÑ –ü–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫ –∫–æ–Ω—Ñ–∏–≥–∞:"
            head -10 public/frontend_config.json
          fi

      - name: Download history files
        run: |
          echo "üìä Downloading history files..."
          
          CACHE_BUSTER=$(date +%s)_$RANDOM
          DOWNLOADED=0
          
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ API
          TEMP_LIST=$(mktemp)
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               "https://api.github.com/repos/${{ github.repository }}/contents/data/" > $TEMP_LIST
          
          # –ü–∞—Ä—Å–∏–º JSON –∏ —Å–∫–∞—á–∏–≤–∞–µ–º –∫–∞–∂–¥—ã–π history —Ñ–∞–π–ª
          grep -o '"name":"history_[^"]*\.json"' $TEMP_LIST | cut -d'"' -f4 | while read file; do
            if [ ! -z "$file" ]; then
              echo "  üì• Downloading $file..."
          
              # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
              if curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                    -H "Accept: application/vnd.github.v3.raw" \
                    -o "public/data/history/$file" \
                    "https://api.github.com/repos/${{ github.repository }}/contents/data/$file?ref=main&cache=$CACHE_BUSTER"; then
                DOWNLOADED=$((DOWNLOADED + 1))
                echo "    ‚úÖ –£—Å–ø–µ—à–Ω–æ"
              else
                # –ü—Ä–æ–±—É–µ–º raw GitHub
                if curl -s -H "Cache-Control: no-cache" \
                      -o "public/data/history/$file" \
                      "https://raw.githubusercontent.com/${{ github.repository }}/main/data/$file?nocache=$CACHE_BUSTER"; then
                  DOWNLOADED=$((DOWNLOADED + 1))
                  echo "    ‚úÖ –£—Å–ø–µ—à–Ω–æ (raw)"
                else
                  echo "    ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å $file"
                fi
              fi
            fi
          done
          
          rm $TEMP_LIST
          
          # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Ñ–µ—Ä–º –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
          if [ -f public/frontend_config.json ]; then
            FARMS=$(grep -o '"id":"[^"]*"' public/frontend_config.json | cut -d'"' -f4 || echo "")
            echo "$FARMS" | while read farm; do
              if [ ! -z "$farm" ] && [ ! -f "public/data/history/history_${farm}.json" ]; then
                echo "  üìù –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è $farm"
                echo "{\"farm_history\":[],\"last_update\":\"$(date -Iseconds)\",\"total_entries\":0,\"farm_name\":\"$farm\",\"version\":\"2.0\"}" > "public/data/history/history_${farm}.json"
              fi
            done
          fi
          
          COUNT=$(ls -1 public/data/history/*.json 2>/dev/null | wc -l)
          echo "‚úÖ Downloaded/created $COUNT history files"

      # ===== –ù–û–í–´–ô –®–ê–ì: –°–æ–∑–¥–∞–Ω–∏–µ –≤–µ—Ä—Å–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ =====
      - name: Create version file
        run: |
          echo "üìù Creating version file..."
          TIMESTAMP=$(date -Iseconds)
          COMMIT=$(git rev-parse --short HEAD)
          
          cat > public/version.json << EOF
          {
            "version": "${{ env.APP_VERSION }}",
            "buildTime": "$TIMESTAMP",
            "commit": "$COMMIT",
            "files": $(ls -1 public/data/history/*.json 2>/dev/null | wc -l | xargs echo),
            "farms": $(grep -o '"id":"[^"]*"' public/frontend_config.json 2>/dev/null | wc -l || echo 0)
          }
          EOF
          
          echo "‚úÖ Version file created"

      - name: Build React app
        run: |
          echo "üî® Building React app..."
          CI=false GENERATE_SOURCEMAP=false npm run build
          
          # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ –≤ build
          if [ -f public/frontend_config.json ]; then
            cp public/frontend_config.json build/
            echo "‚úÖ Config copied to build"
          fi
          
          if [ -f public/version.json ]; then
            cp public/version.json build/
            echo "‚úÖ Version copied to build"
          fi
          
          if [ -f public/available_files.txt ]; then
            cp public/available_files.txt build/
            echo "‚úÖ File list copied to build"
          fi
          
          if [ -d public/data/history ]; then
            mkdir -p build/data/history
            cp -r public/data/history/* build/data/history/ 2>/dev/null || true
            echo "‚úÖ History copied to build ($(ls -1 build/data/history/ | wc -l) files)"
          fi
          
          echo "‚úÖ Build completed"

      # ===== –ù–û–í–´–ô –®–ê–ì: –°–æ–∑–¥–∞–Ω–∏–µ cache-busting index.html =====
      - name: Create cache-busting index.html
        run: |
          echo "üîÑ Creating cache-busting index.html..."
          TIMESTAMP=$(date +%s)
          
          # –î–æ–±–∞–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é –≤ index.html –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          sed -i "s/<\/head>/<meta name=\"build-time\" content=\"$TIMESTAMP\"><\/head>/" build/index.html
          
          echo "‚úÖ Cache-busting meta added"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './build'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # ===== –ù–û–í–´–ô –®–ê–ì: –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ CloudFlare (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ) =====
      - name: Purge CloudFlare cache (optional)
        if: false  # –í–∫–ª—é—á–∏ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å CloudFlare
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/zones/YOUR_ZONE_ID/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CF_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}'

      - name: Deployment info
        run: |
          echo "üéâ Deployment successful!"
          echo "üìÖ Time: $(date)"
          echo "üîó URL: ${{ steps.deployment.outputs.page_url }}"
          echo "üì¶ Version: ${{ env.APP_VERSION }}"
          echo "üîß Build timestamp: $(date +%s)"

      - name: Copy 404.html for SPA routing
        run: |
          if [ -f public/404.html ]; then
            cp public/404.html build/404.html
            echo "‚úÖ 404.html copied for SPA routing"
          else
            echo "‚ö†Ô∏è 404.html not found, creating default..."
            cat > build/404.html << 'EOF'
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="utf-8">
                <title>Mining Monitor - Redirecting...</title>
                <meta http-equiv="refresh" content="0; URL=/mining-monitor-web/">
                <script>
                    sessionStorage.setItem('redirectPath', window.location.pathname.replace('/mining-monitor-web', ''));
                    window.location.href = '/mining-monitor-web/';
                </script>
            </head>
            <body>
                <h1>Redirecting...</h1>
            </body>
            </html>
            EOF
            echo "‚úÖ Default 404.html created"
          fi
name: Deploy Mining Monitor to GitHub Pages

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'

permissions:
  contents: write
  pages: write
  id-token: write
  actions: read

env:
  NODE_VERSION: '18'
  APP_VERSION: '5.0.0'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: github-pages
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --silent || npm install --silent
          echo "âœ… Dependencies installed"

      - name: Create public directories
        run: |
          mkdir -p public/data/history
          mkdir -p public/config
          echo "âœ… Directories created"

      - name: Purge GitHub cache
        run: |
          echo "ğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ĞºÑÑˆĞ° GitHub..."
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -X GET "https://api.github.com/repos/${{ github.repository }}/git/refs/heads/main" > /dev/null
          curl -s "https://raw.githubusercontent.com/${{ github.repository }}/main/data/frontend_config.json?cache_bust=$(date +%s)" > /dev/null
          echo "âœ… ĞšÑÑˆ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½"

      - name: Check files existence
        run: |
          echo "ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ² data/..."
          FILES=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                      "https://api.github.com/repos/${{ github.repository }}/contents/data/" | \
                      grep -o '"name":"[^"]*"' | cut -d'"' -f4)
          echo "ğŸ“‹ ĞĞ°Ğ¹Ğ´ĞµĞ½Ñ‹ Ñ„Ğ°Ğ¹Ğ»Ñ‹:"
          echo "$FILES" | while read file; do
            echo "   - $file"
          done
          echo "$FILES" > public/available_files.txt

      - name: Download frontend config
        run: |
          echo "ğŸ“¥ Downloading frontend config..."
          CACHE_BUSTER=$(date +%s)_$RANDOM
          
          # Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ 1: GitHub API
          if curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3.raw" \
               -o public/frontend_config.json \
               "https://api.github.com/repos/${{ github.repository }}/contents/data/frontend_config.json?ref=main&cache=$CACHE_BUSTER"; then
            echo "âœ… Config downloaded via API"
          else
            # Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ 2: Raw GitHub
            if curl -s -H "Cache-Control: no-cache" \
                 -o public/frontend_config.json \
                 "https://raw.githubusercontent.com/${{ github.repository }}/main/data/frontend_config.json?nocache=$CACHE_BUSTER"; then
              echo "âœ… Config downloaded via raw"
            else
              # Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ 3: jsDelivr
              if curl -s -o public/frontend_config.json \
                   "https://cdn.jsdelivr.net/gh/${{ github.repository }}@main/data/frontend_config.json?t=$CACHE_BUSTER"; then
                echo "âœ… Config downloaded via jsDelivr"
              else
                echo '{"users":[],"farms":[],"user_farm_assignments":{},"version":"5.0"}' > public/frontend_config.json
                echo "âš ï¸ Using empty config"
              fi
            fi
          fi
          
          echo "âœ… Config ready: $(wc -l < public/frontend_config.json) lines"

      - name: Download history files
        run: |
          echo "ğŸ“Š Downloading history files..."
          CACHE_BUSTER=$(date +%s)_$RANDOM
          DOWNLOADED=0
          
          TEMP_LIST=$(mktemp)
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               "https://api.github.com/repos/${{ github.repository }}/contents/data/" > $TEMP_LIST
          
          grep -o '"name":"history_[^"]*\.json"' $TEMP_LIST | cut -d'"' -f4 | while read file; do
            if [ ! -z "$file" ]; then
              echo "  ğŸ“¥ Downloading $file..."
          
              if curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                    -H "Accept: application/vnd.github.v3.raw" \
                    -o "public/data/history/$file" \
                    "https://api.github.com/repos/${{ github.repository }}/contents/data/$file?ref=main&cache=$CACHE_BUSTER"; then
                DOWNLOADED=$((DOWNLOADED + 1))
                echo "    âœ… Success"
              else
                if curl -s -H "Cache-Control: no-cache" \
                      -o "public/data/history/$file" \
                      "https://raw.githubusercontent.com/${{ github.repository }}/main/data/$file?nocache=$CACHE_BUSTER"; then
                  DOWNLOADED=$((DOWNLOADED + 1))
                  echo "    âœ… Success (raw)"
                else
                  echo "    âŒ Failed to download $file"
                fi
              fi
            fi
          done
          
          rm $TEMP_LIST
          
          if [ -f public/frontend_config.json ]; then
            FARMS=$(grep -o '"id":"[^"]*"' public/frontend_config.json | cut -d'"' -f4 || echo "")
            echo "$FARMS" | while read farm; do
              if [ ! -z "$farm" ] && [ ! -f "public/data/history/history_${farm}.json" ]; then
                echo "  ğŸ“ Creating empty history for $farm"
                echo "{\"farm_history\":[],\"last_update\":\"$(date -Iseconds)\",\"total_entries\":0,\"farm_name\":\"$farm\",\"version\":\"2.0\"}" > "public/data/history/history_${farm}.json"
              fi
            done
          fi
          
          COUNT=$(ls -1 public/data/history/*.json 2>/dev/null | wc -l)
          echo "âœ… Downloaded/created $COUNT history files"

      - name: Create version file
        run: |
          echo "ğŸ“ Creating version file..."
          TIMESTAMP=$(date -Iseconds)
          COMMIT=$(git rev-parse --short HEAD)
          
          cat > public/version.json << EOF
          {
            "version": "${{ env.APP_VERSION }}",
            "buildTime": "$TIMESTAMP",
            "commit": "$COMMIT",
            "files": $(ls -1 public/data/history/*.json 2>/dev/null | wc -l),
            "farms": $(grep -o '"id":"[^"]*"' public/frontend_config.json 2>/dev/null | wc -l || echo 0)
          }
          EOF
          
          echo "âœ… Version file created"

      - name: Build React app
        run: |
          echo "ğŸ”¨ Building React app..."
          CI=false GENERATE_SOURCEMAP=false npm run build
          
          cp public/frontend_config.json build/ 2>/dev/null || true
          cp public/version.json build/ 2>/dev/null || true
          cp public/available_files.txt build/ 2>/dev/null || true
          
          if [ -d public/data/history ]; then
            mkdir -p build/data/history
            cp -r public/data/history/* build/data/history/ 2>/dev/null || true
          fi
          
          echo "âœ… Build completed"

      - name: Create cache-busting index
        run: |
          echo "ğŸ”„ Creating cache-busting index..."
          TIMESTAMP=$(date +%s)
          sed -i "s/<\/head>/<meta name=\"build-time\" content=\"$TIMESTAMP\"><\/head>/" build/index.html
          echo "âœ… Cache-busting meta added"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './build'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Copy 404.html for SPA routing
        run: |
          if [ -f public/404.html ]; then
            cp public/404.html build/404.html
            echo "âœ… 404.html copied"
          else
            echo "âš ï¸ 404.html not found, creating default..."
            cat > build/404.html << 'EOF'
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="utf-8">
                <title>Mining Monitor - Redirecting...</title>
                <meta http-equiv="refresh" content="0; URL=/mining-monitor-web/">
                <script>
                    sessionStorage.setItem('redirectPath', window.location.pathname.replace('/mining-monitor-web', ''));
                    window.location.href = '/mining-monitor-web/';
                </script>
            </head>
            <body>
                <h1>Redirecting...</h1>
            </body>
            </html>
            EOF
            echo "âœ… Default 404.html created"
          fi

      - name: Deployment info
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo "ğŸ“… Time: $(date)"
          echo "ğŸ”— URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“¦ Version: ${{ env.APP_VERSION }}"
          echo "ğŸ”§ Build timestamp: $(date +%s)"
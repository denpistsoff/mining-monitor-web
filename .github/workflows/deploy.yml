name: Deploy Mining Monitor to GitHub Pages

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

# Ğ’Ğ°Ğ¶Ğ½Ğ¾! Ğ”Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ½Ğ° Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ
permissions:
  contents: write
  pages: write
  id-token: write
  actions: read

env:
  NODE_VERSION: '18'
  APP_VERSION: '5.0.0'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: github-pages
    
    steps:
      # Ğ’Ğ°Ğ¶Ğ½Ğ¾! Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ GITHUB_TOKEN Ğ´Ğ»Ñ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½, Ğ° Ğ½Ğµ GH_TOKEN
          persist-credentials: true
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --silent || npm install --silent
          echo "âœ… Dependencies installed"

      - name: Create public directories
        run: |
          mkdir -p public/data/history
          mkdir -p public/config
          echo "âœ… Directories created"

      - name: Download frontend config
        run: |
          echo "ğŸ“¥ Downloading frontend config..."
          # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ GITHUB_TOKEN Ğ´Ğ»Ñ API Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3.raw" \
               -o public/frontend_config.json \
               https://api.github.com/repos/${{ github.repository }}/contents/data/frontend_config.json || \
          echo '{"users":[],"farms":[],"user_farm_assignments":{},"version":"5.0"}' > public/frontend_config.json
          
          if [ -f public/frontend_config.json ]; then
            echo "âœ… Config downloaded: $(wc -l < public/frontend_config.json) lines"
          fi

      - name: Download history files
        run: |
          echo "ğŸ“Š Downloading history files..."
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ» Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞºĞ°
          TEMP_LIST=$(mktemp)
          
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ñ‡ĞµÑ€ĞµĞ· API
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               "https://api.github.com/repos/${{ github.repository }}/contents/data/" > $TEMP_LIST
          
          # ĞŸĞ°Ñ€ÑĞ¸Ğ¼ JSON Ğ¸ ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ history Ñ„Ğ°Ğ¹Ğ»
          grep -o '"name":"history_[^"]*\.json"' $TEMP_LIST | cut -d'"' -f4 | while read file; do
            if [ ! -z "$file" ]; then
              echo "  ğŸ“¥ Downloading $file..."
              curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                   -H "Accept: application/vnd.github.v3.raw" \
                   -o "public/data/history/$file" \
                   "https://api.github.com/repos/${{ github.repository }}/contents/data/$file"
            fi
          done
          
          rm $TEMP_LIST
          
          # Ğ¡Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ ÑĞºĞ°Ñ‡Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
          if [ -d public/data/history ]; then
            COUNT=$(ls -1 public/data/history/*.json 2>/dev/null | wc -l)
            echo "âœ… Downloaded $COUNT history files"
          fi

      - name: Build React app
        run: |
          echo "ğŸ”¨ Building React app..."
          CI=false GENERATE_SOURCEMAP=false npm run build
          
          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¸ Ğ² build
          if [ -f public/frontend_config.json ]; then
            cp public/frontend_config.json build/
            echo "âœ… Config copied to build"
          fi
          
          if [ -d public/data/history ]; then
            mkdir -p build/data/history
            cp -r public/data/history/* build/data/history/ 2>/dev/null || true
            echo "âœ… History copied to build"
          fi
          
          echo "âœ… Build completed"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './build'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment info
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo "ğŸ“… Time: $(date)"
          echo "ğŸ”— URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“¦ Version: ${{ env.APP_VERSION }}"
          
      # Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ ÑÑ‚Ğ¾Ñ‚ ÑˆĞ°Ğ³ Ğ¿Ğ¾ÑĞ»Ğµ build
      - name: Copy 404.html for SPA routing
        run: |
          cp public/404.html build/404.html
          echo "âœ… 404.html copied for SPA routing"
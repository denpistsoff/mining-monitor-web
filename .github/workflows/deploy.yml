name: Deploy Mining Monitor to GitHub Pages

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy even without changes'
        required: false
        default: false
        type: boolean

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ permissions
permissions:
  contents: write
  pages: write
  id-token: write
  actions: read

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
env:
  NODE_VERSION: '18'
  APP_VERSION: '5.0.0'
  REPO_NAME: 'denpistsoff/mining-monitor-web'

jobs:
  # Job 1: –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_time: ${{ steps.time.outputs.time }}
    
    steps:
      - name: ‚è±Ô∏è Set build time
        id: time
        run: echo "time=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: üî¢ Get version
        id: version
        run: echo "version=${{ env.APP_VERSION }}" >> $GITHUB_OUTPUT

      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: üèóÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: |
          echo "Installing npm packages..."
          npm ci --silent || npm install --silent
          echo "‚úÖ Dependencies installed"

      - name: üîß Create environment file
        run: |
          cat > .env << EOF
          REACT_APP_GITHUB_TOKEN=${{ secrets.GH_TOKEN }}
          REACT_APP_GITHUB_REPO=${{ env.REPO_NAME }}
          REACT_APP_VERSION=${{ env.APP_VERSION }}
          REACT_APP_BUILD_TIME=$(date +%s)
          REACT_APP_BUILD_DATE="$(date +'%Y-%m-%d %H:%M:%S')"
          EOF
          echo "‚úÖ Environment file created"

      - name: üìÇ Create public directories
        run: |
          mkdir -p public/data/history
          mkdir -p public/config
          echo "‚úÖ Directories created"

      - name: ‚¨áÔ∏è Download frontend config
        run: |
          echo "üì• Downloading frontend config..."
          CONFIG_URL="https://api.github.com/repos/${{ env.REPO_NAME }}/contents/data/frontend_config.json"
          
          # –ü—Ä–æ–±—É–µ–º —Å–∫–∞—á–∞—Ç—å —á–µ—Ä–µ–∑ API
          HTTP_CODE=$(curl -s -w "%{http_code}" -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
               -H "Accept: application/vnd.github.v3.raw" \
               -o public/config/frontend_config.json \
               $CONFIG_URL)
          
          if [ "$HTTP_CODE" = "200" ] && [ -f public/config/frontend_config.json ]; then
            echo "‚úÖ frontend_config.json downloaded successfully"
            echo "   File size: $(wc -l < public/config/frontend_config.json) lines"
            cp public/config/frontend_config.json public/frontend_config.json
          else
            echo "‚ö†Ô∏è frontend_config.json not found (HTTP $HTTP_CODE), creating default"
            cat > public/frontend_config.json << 'EOF'
  {
    "users": [],
    "farms": [],
    "user_farm_assignments": {},
    "version": "5.0",
    "last_export": "$(date -Iseconds)",
    "farm_name": "default"
  }
  EOF
  fi

- name: ‚¨áÔ∏è Download history files
  run: |
    echo "üìä Downloading history files..."
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ GitHub API
    API_URL="https://api.github.com/repos/${{ env.REPO_NAME }}/contents/data/"
    FILES=$(curl -s -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
      $API_URL | grep -o '"name":"history_[^"]*\.json"' | cut -d'"' -f4 || echo "")
    
    DOWNLOAD_COUNT=0
    if [ -n "$FILES" ]; then
      echo "$FILES" | while IFS= read -r file; do
        if [ -n "$file" ]; then
          echo "  üì• Downloading $file..."
          curl -s -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
               -H "Accept: application/vnd.github.v3.raw" \
               -o "public/data/history/$file" \
               "https://api.github.com/repos/${{ env.REPO_NAME }}/contents/data/$file"
    
          if [ -f "public/data/history/$file" ]; then
            DOWNLOAD_COUNT=$((DOWNLOAD_COUNT + 1))
          fi
        fi
      done
    fi
    
    echo "‚úÖ Downloaded $DOWNLOAD_COUNT history files"

- name: üèóÔ∏è Build React application
  run: |
    echo "üî® Building React app..."
    CI=false GENERATE_SOURCEMAP=false npm run build
    echo "‚úÖ Build completed"

- name: üìã Copy configuration files to build
  run: |
    echo "üìã Copying configs to build directory..."
    
    # –ö–æ–ø–∏—Ä—É–µ–º frontend config
    if [ -f public/frontend_config.json ]; then
      cp public/frontend_config.json build/frontend_config.json
      echo "  ‚úÖ frontend_config.json copied"
    fi
    
    # –ö–æ–ø–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é
    if [ -d public/data/history ] && [ "$(ls -A public/data/history)" ]; then
      mkdir -p build/data/history
      cp public/data/history/*.json build/data/history/
      echo "  ‚úÖ History files copied: $(ls build/data/history/ | wc -l) files"
    fi
    
    # –°–æ–∑–¥–∞–µ–º build info
    cat > build/build-info.json << EOF
  {
    "version": "${{ env.APP_VERSION }}",
    "buildTime": "$(date -Iseconds)",
    "commit": "$(git rev-parse --short HEAD)",
    "branch": "$(git rev-parse --abbrev-ref HEAD)",
    "multiUser": true,
    "authType": "config-based",
    "features": {
      "history": true,
      "alerts": true,
      "multiUser": true,
      "telegram": true
    }
  }
  EOF
  echo "  ‚úÖ build-info.json created"
  
  # –°–æ–∑–¥–∞–µ–º .htaccess –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
  cat > build/.htaccess << EOF
  Options -MultiViews
  RewriteEngine On
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteRule ^ index.html [QSA,L]
  
  # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
  <FilesMatch "\.(ico|pdf|flv|jpg|jpeg|png|gif|js|css|swf)$">
  Header set Cache-Control "max-age=2592000, public"
  </FilesMatch>
  EOF
  echo "  ‚úÖ .htaccess created"

- name: üì§ Upload build artifact
  uses: actions/upload-pages-artifact@v3
  with:
    path: ./build

# Job 2: –î–µ–ø–ª–æ–π –Ω–∞ GitHub Pages
deploy:
  runs-on: ubuntu-latest
  needs: build
  environment:
    name: github-pages
    url: ${{ steps.deployment.outputs.page_url }}
  
  steps:
    - name: üöÄ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: ‚úÖ Deployment completed
      run: |
        echo "‚úÖ Application deployed successfully!"
        echo "   Version: ${{ needs.build.outputs.version }}"
        echo "   Build time: ${{ needs.build.outputs.build_time }}"
        echo "   URL: ${{ steps.deployment.outputs.page_url }}"

# Job 3: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
sync-history:
  runs-on: ubuntu-latest
  needs: deploy
  if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
  
  steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0

    - name: üîß Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: üîÑ Sync history files
      run: |
        echo "üîÑ Syncing history files..."
        
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        mkdir -p temp_history
        
        # –°–∫–∞—á–∏–≤–∞–µ–º —Å–≤–µ–∂–∏–µ history —Ñ–∞–π–ª—ã
        API_URL="https://api.github.com/repos/${{ env.REPO_NAME }}/contents/data/"
        FILES=$(curl -s -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
          $API_URL | grep -o '"name":"history_[^"]*\.json"' | cut -d'"' -f4 || echo "")
        
        CHANGES=false
        
        if [ -n "$FILES" ]; then
          echo "$FILES" | while IFS= read -r file; do
            if [ -n "$file" ]; then
              # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
              curl -s -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
                   -o "temp_history/$file" \
                   "https://raw.githubusercontent.com/${{ env.REPO_NAME }}/main/data/$file"
        
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
              if [ -f "data/$file" ]; then
                if ! cmp -s "data/$file" "temp_history/$file"; then
                  echo "  üìù Updated: $file"
                  cp "temp_history/$file" "data/$file"
                  git add "data/$file"
                  CHANGES=true
                fi
              else
                echo "  üÜï New: $file"
                cp "temp_history/$file" "data/$file"
                git add "data/$file"
                CHANGES=true
              fi
            fi
          done
        fi
        
        echo "has_changes=$CHANGES" >> $GITHUB_ENV

    - name: üì§ Commit and push changes
      if: env.has_changes == 'true'
      run: |
        git commit -m "ü§ñ Auto-sync farm history [skip ci]"
        git push
        echo "‚úÖ History files synced successfully"

# Job 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
health-check:
  runs-on: ubuntu-latest
  needs: deploy
  if: always()
  
  steps:
    - name: üè• Check deployment health
      run: |
        echo "üè• Running health checks..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–∞–π—Ç–∞
        DEPLOY_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo "   Checking: $DEPLOY_URL"
        
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOY_URL" || echo "000")
        
        if [ "$HTTP_CODE" = "200" ]; then
          echo "‚úÖ Site is accessible (HTTP $HTTP_CODE)"
        else
          echo "‚ö†Ô∏è Site returned HTTP $HTTP_CODE"
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞
        CONFIG_URL="${DEPLOY_URL}frontend_config.json"
        CONFIG_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$CONFIG_URL" || echo "000")
        
        if [ "$CONFIG_CODE" = "200" ]; then
          echo "‚úÖ Config file is accessible"
        else
          echo "‚ö†Ô∏è Config file not accessible (HTTP $CONFIG_CODE)"
        fi
        
        echo "‚úÖ Health check completed"

# Job 5: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
notify:
  runs-on: ubuntu-latest
  needs: [deploy, health-check]
  if: success()
  
  steps:
    - name: üí¨ Send success notification
      run: |
        echo "üéâ Deployment completed successfully!"
        echo "   Version: ${{ needs.build.outputs.version }}"
        echo "   Time: ${{ needs.build.outputs.build_time }}"
        echo "   Repository: ${{ github.repository }}"
        echo "   Commit: ${{ github.sha }}"
        
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –≤ Telegram/Slack
        # curl -X POST -H "Content-Type: application/json" ...
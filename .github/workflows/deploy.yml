name: Deploy React App to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm install
        
      - name: Download farm data
        run: |
          mkdir -p public/data
          echo "üîç Downloading farm data..."
          
          # –°–∫–∞—á–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
          curl -s -o public/data/farm_data.json "https://raw.githubusercontent.com/denpistsoff/mining-monitor/main/data/farm_data.json" || echo "Download failed"
          
          echo "=== DATA VALIDATION ==="
          echo "File size: $(wc -c < public/data/farm_data.json) bytes"
          echo "First 500 chars:"
          head -c 500 public/data/farm_data.json
          echo ""
          echo "=== JSON STRUCTURE ==="
          python3 -c "
import json
try:
    with open('public/data/farm_data.json', 'r') as f:
        data = json.load(f)
    print('‚úÖ JSON valid')
    print(f'Farm name: {data.get(\"farm_name\", \"NOT FOUND\")}')
    print(f'Containers: {len(data.get(\"containers\", {}))}')
    print(f'Last update: {data.get(\"last_update\", \"NOT FOUND\")}')
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É summary
    if 'summary' in data:
        summary = data['summary']
        print(f'Summary - Containers: {summary.get(\"total_containers\", \"NOT FOUND\")}')
        print(f'Summary - Miners: {summary.get(\"total_miners\", \"NOT FOUND\")}')
    else:
        print('‚ùå No summary section found')
        
except Exception as e:
    print(f'‚ùå JSON error: {e}')
          "
          
          # –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é –¥–ª—è –±–∏–ª–¥–∞
          cp -r public/data build/ 2>/dev/null || mkdir -p build/data && cp public/data/farm_data.json build/data/
          touch build/.nojekyll
        
      - name: Build React app
        run: |
          echo "üèóÔ∏è Building React app..."
          npm run build
          echo "=== BUILD FILES ==="
          find build/ -name "*.json" | head -10
          ls -la build/data/ 2>/dev/null || echo "No data directory in build"
        
      - name: Verify build contains data
        run: |
          echo "=== VERIFYING BUILD ==="
          if [ -f "build/data/farm_data.json" ]; then
            echo "‚úÖ farm_data.json found in build"
            echo "Build file size: $(wc -c < build/data/farm_data.json) bytes"
          else
            echo "‚ùå farm_data.json NOT found in build"
            find build/ -name "*.json" | head -10
          fi
        
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./build

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
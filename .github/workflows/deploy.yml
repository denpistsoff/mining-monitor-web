name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑÑ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¾Ğ²
          
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Create site structure
        run: |
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ±Ğ°Ğ·Ğ¾Ğ²ÑƒÑ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ
          mkdir -p docs
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ index.html Ğ² docs/ (ÑÑ‚Ğ¾ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ GitHub Pages)
          cat > docs/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="ru">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Mining Monitor</title>
              <link rel="stylesheet" href="styles.css">
          </head>
          <body>
              <div class="container">
                  <header>
                      <h1>ğŸ¤– Mining Monitor</h1>
                      <p>Last update: <span id="updateTime">-</span></p>
                  </header>
                  <div class="cards" id="summary"></div>
                  <div id="containers"></div>
              </div>
              <script src="app.js"></script>
          </body>
          </html>
          EOF
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ´Ğ»Ñ Ğ»ÑƒÑ‡ÑˆĞµĞ¹ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
          cat > docs/styles.css << 'EOF'
          * { margin: 0; padding: 0; box-sizing: border-box; }
          body { 
              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
              background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
              color: white; 
              min-height: 100vh;
              padding: 20px;
          }
          .container { 
              max-width: 1200px; 
              margin: 0 auto; 
          }
          header { 
              text-align: center; 
              margin-bottom: 40px;
              padding: 20px;
          }
          header h1 {
              font-size: 2.5em;
              margin-bottom: 10px;
              background: linear-gradient(45deg, #4ecca3, #00b4d8);
              -webkit-background-clip: text;
              -webkit-text-fill-color: transparent;
          }
          .cards { 
              display: grid; 
              grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
              gap: 20px; 
              margin-bottom: 40px; 
          }
          .card { 
              background: rgba(255, 255, 255, 0.1);
              backdrop-filter: blur(10px);
              padding: 25px; 
              border-radius: 15px; 
              text-align: center;
              border: 1px solid rgba(255, 255, 255, 0.2);
              transition: transform 0.3s ease;
          }
          .card:hover {
              transform: translateY(-5px);
          }
          .card h3 { 
              color: #4ecca3; 
              margin-bottom: 15px;
              font-size: 1.1em;
          }
          .card .value { 
              font-size: 28px; 
              font-weight: bold;
              color: #fff;
          }
          .container-card { 
              background: rgba(22, 33, 62, 0.8);
              padding: 20px; 
              border-radius: 12px; 
              margin-bottom: 15px;
              border-left: 4px solid #4ecca3;
          }
          .container-card h3 {
              color: #4ecca3;
              margin-bottom: 10px;
              font-size: 1.3em;
          }
          .miner { 
              display: flex; 
              justify-content: space-between; 
              align-items: center;
              padding: 8px 0; 
              border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
          }
          .miner:last-child {
              border-bottom: none;
          }
          .online { color: #4ecca3; font-weight: bold; }
          .offline { color: #ff6b6b; }
          .miner-info { display: flex; align-items: center; gap: 10px; }
          .status-dot {
              width: 8px;
              height: 8px;
              border-radius: 50%;
              display: inline-block;
          }
          .online .status-dot { background: #4ecca3; }
          .offline .status-dot { background: #ff6b6b; }
          EOF
          
          cat > docs/app.js << 'EOF'
          async function loadData() {
              try {
                  const response = await fetch('./data/farm_data.json?t=' + Date.now());
                  if (!response.ok) throw new Error('Network response was not ok');
                  const data = await response.json();
                  render(data);
              } catch (error) {
                  console.error('Error loading data:', error);
                  document.getElementById('containers').innerHTML = 
                      '<div class="container-card"><p>âš ï¸ Error loading data. Please try again later.</p></div>';
              }
          }

          function render(data) {
              // Summary cards
              document.getElementById('summary').innerHTML = `
                  <div class="card">
                      <h3>ğŸ—ï¸ Containers</h3>
                      <div class="value">${data.summary?.total_containers || 0}</div>
                  </div>
                  <div class="card">
                      <h3>â›ï¸ Miners</h3>
                      <div class="value">${data.summary?.online_miners || 0}<small>/ ${data.summary?.total_miners || 0}</small></div>
                  </div>
                  <div class="card">
                      <h3>âš¡ Hashrate</h3>
                      <div class="value">${(data.summary?.total_hashrate || 0).toLocaleString()} TH/s</div>
                  </div>
                  <div class="card">
                      <h3>ğŸ”‹ Power</h3>
                      <div class="value">${data.summary?.total_power || 0} W</div>
                  </div>
              `;

              // Containers
              let containersHTML = '';
              if (data.containers && Object.keys(data.containers).length > 0) {
                  for (const [id, container] of Object.entries(data.containers)) {
                      containersHTML += `
                          <div class="container-card">
                              <h3>ğŸ“¦ ${id}</h3>
                              <div class="miner-info">
                                  <span>Miners: ${container.online_miners}/${container.total_miners}</span>
                                  <span>Hashrate: ${container.total_hashrate} TH/s</span>
                              </div>
                              ${container.miners.map(miner => `
                                  <div class="miner">
                                      <div class="miner-info">
                                          <span class="status-dot"></span>
                                          <span>${miner.ip}</span>
                                          <small>${miner.pool}</small>
                                      </div>
                                      <span class="${miner.status}">
                                          ${miner.status === 'online' ? 'ğŸŸ¢' : 'ğŸ”´'} ${miner.hashrate} TH/s
                                      </span>
                                  </div>
                              `).join('')}
                          </div>
                      `;
                  }
              } else {
                  containersHTML = '<div class="container-card"><p>No mining data available</p></div>';
              }
              
              document.getElementById('containers').innerHTML = containersHTML;
              document.getElementById('updateTime').textContent = 
                  data.last_update ? new Date(data.last_update).toLocaleString() : 'Never';
          }

          // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑÑ€Ğ°Ğ·Ñƒ Ğ¸ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 30 ÑĞµĞºÑƒĞ½Ğ´
          loadData();
          setInterval(loadData, 30000);
          EOF
          
          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ¸ ĞµÑÑ‚ÑŒ
          mkdir -p docs/data
          if [ -f "data/farm_data.json" ]; then
              cp data/farm_data.json docs/data/
              echo "âœ… Data file copied"
          else
              echo '{"last_update": "2024-01-01T00:00:00", "summary": {}, "containers": {}}' > docs/data/farm_data.json
              echo "âš ï¸ No data file found, created placeholder"
          fi
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
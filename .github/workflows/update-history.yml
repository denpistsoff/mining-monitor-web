name: Update Farm History

on:
  schedule:
    - cron: '*/30 * * * *'  # –ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  update-history:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Update farm history
        run: |
          # –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
          cat > update-history.js << 'EOF'
          const https = require('https');
          const fs = require('fs');
          
          const FARM_NAME = 'main'; // –ò–∑–º–µ–Ω–∏ –Ω–∞ –Ω—É–∂–Ω–æ–µ –∏–º—è —Ñ–µ—Ä–º—ã
          
          async function updateHistory() {
            try {
              console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Ñ–µ—Ä–º—ã...');
          
              // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Ñ–µ—Ä–º—ã
              const currentData = await fetchFarmData(FARM_NAME);
              if (!currentData || currentData._isOfflineData) {
                console.log('‚ùå –§–µ—Ä–º–∞ offline, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ');
                return;
              }
          
              console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', {
                hashrate: currentData.summary?.total_hashrate,
                power: currentData.summary?.total_power,
                miners: currentData.summary?.online_miners
              });
          
              // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∏—Å—Ç–æ—Ä–∏—é
              const history = await loadHistory(FARM_NAME);
          
              // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
              const now = new Date();
              const minutes = now.getMinutes();
              const roundedMinutes = minutes < 30 ? 0 : 30;
              const timestamp = new Date(now);
              timestamp.setMinutes(roundedMinutes, 0, 0);
          
              const newEntry = {
                timestamp: timestamp.toISOString(),
                time_label: `${timestamp.getHours().toString().padStart(2, '0')}:${roundedMinutes.toString().padStart(2, '0')}`,
                date: timestamp.toLocaleDateString('ru-RU'),
                total_hashrate: currentData.summary?.total_hashrate || 0,
                total_power: currentData.summary?.total_power || 0,
                online_miners: currentData.summary?.online_miners || 0,
                problematic_miners: currentData.summary?.problematic_miners || 0,
                total_miners: currentData.summary?.total_miners || 0,
                efficiency: currentData.summary?.total_hashrate && currentData.summary.total_power ? 
                  parseFloat((currentData.summary.total_hashrate / (currentData.summary.total_power / 1000)).toFixed(3)) : 0
              };
          
              console.log('üìä –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å:', newEntry);
          
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è —ç—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–ª–æ—Ç–∞
              const existingIndex = history.farm_history.findIndex(entry => 
                entry.time_label === newEntry.time_label && 
                entry.date === newEntry.date
              );
          
              if (existingIndex === -1) {
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –≤ –Ω–∞—á–∞–ª–æ
                history.farm_history.unshift(newEntry);
                console.log('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é');
              } else {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
                history.farm_history[existingIndex] = newEntry;
                console.log('‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∑–∞–ø–∏—Å—å');
              }
          
              // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ (2 –Ω–µ–¥–µ–ª–∏)
              if (history.farm_history.length > 672) { // 14 –¥–Ω–µ–π * 48 –∑–∞–ø–∏—Å–µ–π –≤ –¥–µ–Ω—å
                history.farm_history = history.farm_history.slice(0, 672);
                console.log('‚úÇÔ∏è –û–±—Ä–µ–∑–∞–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –¥–æ 672 –∑–∞–ø–∏—Å–µ–π');
              }
          
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
              await saveHistory(FARM_NAME, history);
              console.log('üíæ –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
          
            } catch (error) {
              console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏:', error);
            }
          }
          
          async function fetchFarmData(farmName) {
            return new Promise((resolve) => {
              const url = `https://raw.githubusercontent.com/denpistsoff/mining-monitor-web/main/data/farm_data_${farmName}.json?t=${Date.now()}`;
          
              https.get(url, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    resolve(JSON.parse(data));
                  } catch {
                    console.log('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö —Ñ–µ—Ä–º—ã');
                    resolve(null);
                  }
                });
              }).on('error', (err) => {
                console.log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ñ–µ—Ä–º—ã:', err.message);
                resolve(null);
              });
            });
          }
          
          async function loadHistory(farmName) {
            try {
              const historyFile = `data/farm_history_${farmName}.json`;
              if (fs.existsSync(historyFile)) {
                const history = JSON.parse(fs.readFileSync(historyFile, 'utf8'));
                console.log(`üìñ –ó–∞–≥—Ä—É–∂–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –∏–∑ ${historyFile}, –∑–∞–ø–∏—Å–µ–π: ${history.farm_history.length}`);
                return history;
              }
            } catch (error) {
              console.log('üìù –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é');
            }
            return { farm_history: [] };
          }
          
          async function saveHistory(farmName, history) {
            const historyFile = `data/farm_history_${farmName}.json`;
            fs.writeFileSync(historyFile, JSON.stringify(history, null, 2));
            console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ ${historyFile}, –∑–∞–ø–∏—Å–µ–π: ${history.farm_history.length}`);
          }
          
          updateHistory();
          EOF
          
          node update-history.js

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/farm_history_*.json
          git diff --staged --quiet || (git commit -m "ü§ñ Auto-update farm history [skip ci]" && git push)
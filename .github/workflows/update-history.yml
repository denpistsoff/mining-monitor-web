name: Update Farm History

on:
  schedule:
    - cron: '*/30 * * * *'  # ÐšÐ°Ð¶Ð´Ñ‹Ðµ 30 Ð¼Ð¸Ð½ÑƒÑ‚
  workflow_dispatch:  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

jobs:
  update-history:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Update farm history
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸
          cat > update-history.js << 'EOF'
          const https = require('https');
          const fs = require('fs');
          
          const FARM_NAME = 'main'; // Ð˜Ð·Ð¼ÐµÐ½Ð¸ Ð½Ð° Ð½ÑƒÐ¶Ð½Ð¾Ðµ Ð¸Ð¼Ñ Ñ„ÐµÑ€Ð¼Ñ‹
          
          async function updateHistory() {
            try {
              console.log('ðŸ”„ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ„ÐµÑ€Ð¼Ñ‹...');
          
              // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ„ÐµÑ€Ð¼Ñ‹
              const currentData = await fetchFarmData(FARM_NAME);
              if (!currentData || currentData._isOfflineData) {
                console.log('âŒ Ð¤ÐµÑ€Ð¼Ð° offline, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ');
                return;
              }
          
              console.log('âœ… Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ñ‹:', {
                hashrate: currentData.summary?.total_hashrate,
                power: currentData.summary?.total_power,
                miners: currentData.summary?.online_miners
              });
          
              // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÑƒÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ
              const history = await loadHistory(FARM_NAME);
          
              // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ Ð·Ð°Ð¿Ð¸ÑÑŒ
              const now = new Date();
              const minutes = now.getMinutes();
              const roundedMinutes = minutes < 30 ? 0 : 30;
              const timestamp = new Date(now);
              timestamp.setMinutes(roundedMinutes, 0, 0);
          
              const newEntry = {
                timestamp: timestamp.toISOString(),
                time_label: `${timestamp.getHours().toString().padStart(2, '0')}:${roundedMinutes.toString().padStart(2, '0')}`,
                date: timestamp.toLocaleDateString('ru-RU'),
                total_hashrate: currentData.summary?.total_hashrate || 0,
                total_power: currentData.summary?.total_power || 0,
                online_miners: currentData.summary?.online_miners || 0,
                problematic_miners: currentData.summary?.problematic_miners || 0,
                total_miners: currentData.summary?.total_miners || 0,
                efficiency: currentData.summary?.total_hashrate && currentData.summary.total_power ? 
                  parseFloat((currentData.summary.total_hashrate / (currentData.summary.total_power / 1000)).toFixed(3)) : 0
              };
          
              console.log('ðŸ“Š ÐÐ¾Ð²Ð°Ñ Ð·Ð°Ð¿Ð¸ÑÑŒ:', newEntry);
          
              // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½ÐµÑ‚ Ð»Ð¸ ÑƒÐ¶Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð´Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð³Ð¾ ÑÐ»Ð¾Ñ‚Ð°
              const existingIndex = history.farm_history.findIndex(entry => 
                entry.time_label === newEntry.time_label && 
                entry.date === newEntry.date
              );
          
              if (existingIndex === -1) {
                // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² Ð½Ð°Ñ‡Ð°Ð»Ð¾
                history.farm_history.unshift(newEntry);
                console.log('âœ… Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° Ð½Ð¾Ð²Ð°Ñ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ');
              } else {
                // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÑƒÑŽ Ð·Ð°Ð¿Ð¸ÑÑŒ
                history.farm_history[existingIndex] = newEntry;
                console.log('âœ… ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð° ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð°Ñ Ð·Ð°Ð¿Ð¸ÑÑŒ');
              }
          
              // ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ (2 Ð½ÐµÐ´ÐµÐ»Ð¸)
              if (history.farm_history.length > 672) { // 14 Ð´Ð½ÐµÐ¹ * 48 Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð² Ð´ÐµÐ½ÑŒ
                history.farm_history = history.farm_history.slice(0, 672);
                console.log('âœ‚ï¸ ÐžÐ±Ñ€ÐµÐ·Ð°Ð½Ð° Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð¾ 672 Ð·Ð°Ð¿Ð¸ÑÐµÐ¹');
              }
          
              // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ
              history.last_update = new Date().toISOString();
              history.farm_name = FARM_NAME;
          
              // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ
              await saveHistory(FARM_NAME, history);
              console.log('ðŸ’¾ Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð°');
          
            } catch (error) {
              console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸:', error);
            }
          }
          
          async function fetchFarmData(farmName) {
            return new Promise((resolve) => {
              const url = `https://raw.githubusercontent.com/denpistsoff/mining-monitor-web/main/data/farm_data_${farmName}.json?t=${Date.now()}`;
          
              https.get(url, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    resolve(JSON.parse(data));
                  } catch {
                    console.log('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ñ„ÐµÑ€Ð¼Ñ‹');
                    resolve(null);
                  }
                });
              }).on('error', (err) => {
                console.log('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ñ„ÐµÑ€Ð¼Ñ‹:', err.message);
                resolve(null);
              });
            });
          }
          
          async function loadHistory(farmName) {
            try {
              const historyFile = `data/farm_history_${farmName}.json`;
              if (fs.existsSync(historyFile)) {
                const history = JSON.parse(fs.readFileSync(historyFile, 'utf8'));
                console.log(`ðŸ“– Ð—Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð° Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¸Ð· ${historyFile}, Ð·Ð°Ð¿Ð¸ÑÐµÐ¹: ${history.farm_history.length}`);
                return history;
              }
            } catch (error) {
              console.log('ðŸ“ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ');
            }
            return { farm_history: [] };
          }
          
          async function saveHistory(farmName, history) {
            const historyFile = `data/farm_history_${farmName}.json`;
            fs.writeFileSync(historyFile, JSON.stringify(history, null, 2));
            console.log(`ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾ Ð² ${historyFile}, Ð·Ð°Ð¿Ð¸ÑÐµÐ¹: ${history.farm_history.length}`);
          }
          
          updateHistory();
          EOF
          
          node update-history.js

      - name: Check if history files were created
        id: check_files
        run: |
          if ls data/farm_history_*.json 1> /dev/null 2>&1; then
            echo "files_changed=true" >> $GITHUB_OUTPUT
          else
            echo "files_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check_files.outputs.files_changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/
          git commit -m "ðŸ¤– Auto-update farm history [skip ci]"
          git push
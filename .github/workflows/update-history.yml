name: Update Farm History

on:
  schedule:
    - cron: '0,30 * * * *'  # ÐšÐ°Ð¶Ð´Ñ‹Ðµ 30 Ð¼Ð¸Ð½ÑƒÑ‚ (Ð² :00 Ð¸ :30)
  workflow_dispatch:  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

jobs:
  update-history:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup jq for JSON processing
        run: sudo apt-get install -y jq

      - name: Update farm history
        run: |
          echo "ðŸ”„ Starting farm history update..."
          
          # ÐŸÑƒÑ‚Ð¸ Ðº Ñ„Ð°Ð¹Ð»Ð°Ð¼
          HISTORY_FILE="data/farm_history_main.json"
          FARM_DATA_URL="https://raw.githubusercontent.com/denpistsoff/mining-monitor-web/main/data/farm_data_main.json?t=$(date +%s)"
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ data ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
          mkdir -p data
          
          # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ„ÐµÑ€Ð¼Ñ‹
          echo "ðŸ“¥ Loading farm data from: $FARM_DATA_URL"
          FARM_JSON=$(curl -f -s "$FARM_DATA_URL" || echo "{}")
          
          if [ "$FARM_JSON" = "{}" ]; then
            echo "âŒ Failed to load farm data"
            exit 0
          fi
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ñ„ÐµÑ€Ð¼Ð° Ð¾Ð½Ð»Ð°Ð¹Ð½ (Ð¸Ñ‰ÐµÐ¼ _isOfflineData Ð¸Ð»Ð¸ _dataStatus)
          if echo "$FARM_JSON" | grep -q "_isOfflineData\" *: *true"; then
            echo "âŒ Farm is offline, skipping update"
            exit 0
          fi
          
          if echo "$FARM_JSON" | grep -q "_dataStatus\" *: *\"offline\""; then
            echo "âŒ Farm data status is offline, skipping update"
            exit 0
          fi
          
          # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· JSON
          HASH_RATE=$(echo "$FARM_JSON" | jq -r '.summary.total_hashrate // 0' 2>/dev/null || echo "0")
          POWER=$(echo "$FARM_JSON" | jq -r '.summary.total_power // 0' 2>/dev/null || echo "0")
          ONLINE_MINERS=$(echo "$FARM_JSON" | jq -r '.summary.online_miners // 0' 2>/dev/null || echo "0")
          PROBLEMATIC_MINERS=$(echo "$FARM_JSON" | jq -r '.summary.problematic_miners // 0' 2>/dev/null || echo "0")
          TOTAL_MINERS=$(echo "$FARM_JSON" | jq -r '.summary.total_miners // 0' 2>/dev/null || echo "0")
          
          echo "âœ… Farm data loaded:"
          echo "   Hash Rate: $HASH_RATE TH/s"
          echo "   Power: $POWER W" 
          echo "   Online Miners: $ONLINE_MINERS"
          echo "   Total Miners: $TOTAL_MINERS"
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð¼ÐµÑ‚ÐºÑƒ (Ð¾ÐºÑ€ÑƒÐ³Ð»ÑÐµÐ¼ Ð´Ð¾ 30 Ð¼Ð¸Ð½ÑƒÑ‚)
          CURRENT_MINUTES=$(date +%M)
          if [ $CURRENT_MINUTES -lt 30 ]; then
            ROUNDED_MINUTES="00"
          else
            ROUNDED_MINUTES="30"
          fi
          
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:${ROUNDED_MINUTES}:00.000Z")
          TIME_LABEL=$(date +"%H:${ROUNDED_MINUTES}")
          DATE_LABEL=$(date +"%d.%m.%Y")
          
          # Ð’Ñ‹Ñ‡Ð¸ÑÐ»ÑÐµÐ¼ ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ (TH/s per kW)
          if [ "$POWER" != "0" ] && [ "$POWER" != "" ] && [ "$POWER" != "null" ]; then
            EFFICIENCY=$(echo "scale=3; $HASH_RATE / ($POWER / 1000)" | bc -l 2>/dev/null || echo "0")
          else
            EFFICIENCY="0"
          fi
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¾Ð±ÑŠÐµÐºÑ‚ Ð½Ð¾Ð²Ð¾Ð¹ Ð·Ð°Ð¿Ð¸ÑÐ¸
          NEW_ENTRY_JSON=$(jq -n \
            --arg timestamp "$TIMESTAMP" \
            --arg time_label "$TIME_LABEL" \
            --arg date "$DATE_LABEL" \
            --argjson hashrate "$HASH_RATE" \
            --argjson power "$POWER" \
            --argjson online_miners "$ONLINE_MINERS" \
            --argjson problematic_miners "$PROBLEMATIC_MINERS" \
            --argjson total_miners "$TOTAL_MINERS" \
            --argjson efficiency "$EFFICIENCY" \
            '{
              timestamp: $timestamp,
              time_label: $time_label,
              date: $date,
              total_hashrate: $hashrate,
              total_power: $power,
              online_miners: $online_miners,
              problematic_miners: $problematic_miners,
              total_miners: $total_miners,
              efficiency: $efficiency
            }')
          
          echo "ðŸ“Š New entry created:"
          echo "$NEW_ENTRY_JSON" | jq '.'
          
          # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÑƒÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¸Ð»Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ
          if [ -f "$HISTORY_FILE" ]; then
            echo "ðŸ“– Loading existing history from $HISTORY_FILE"
            HISTORY_JSON=$(cat "$HISTORY_FILE")
          else
            echo "ðŸŽ¯ Creating NEW history file (first run)"
            HISTORY_JSON='{"farm_name":"main","created_at":"'$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")'","farm_history":[]}'
          fi
          
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ - Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð¸ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€
          UPDATED_HISTORY=$(echo "$HISTORY_JSON" | jq \
            --argjson new_entry "$NEW_ENTRY_JSON" \
            '.farm_history |= [$new_entry] + . |
             .farm_history |= .[0:672] |  # ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ 2 Ð½ÐµÐ´ÐµÐ»ÑÐ¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… (14 Ð´Ð½ÐµÐ¹ * 48 Ð·Ð°Ð¿Ð¸ÑÐµÐ¹/Ð´ÐµÐ½ÑŒ)
             .last_update = (now | strftime("%Y-%m-%dT%H:%M:%S.000Z")) |
             .total_entries = (.farm_history | length)')
          
          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½ÑƒÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ
          echo "$UPDATED_HISTORY" > "$HISTORY_FILE"
          echo "ðŸ’¾ History saved to $HISTORY_FILE"
          echo "ðŸ“ˆ Total entries: $(echo "$UPDATED_HISTORY" | jq '.farm_history | length')"

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/
          git diff --staged --quiet || git commit -m "ðŸ¤– Auto-update farm history $(date +%H:%M)"
          git push
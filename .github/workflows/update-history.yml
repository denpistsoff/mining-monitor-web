name: Update Farm History

on:
  schedule:
    - cron: '0,30 * * * *'  # ÐšÐ°Ð¶Ð´Ñ‹Ðµ 30 Ð¼Ð¸Ð½ÑƒÑ‚ (Ð² :00 Ð¸ :30)
  workflow_dispatch:  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

jobs:
  update-history:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Clear history on manual run
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "ðŸ§¹ Manual run detected - clearing existing history files"
          FARM_NAME="denis"
          HISTORY_FILE="data/farm_history_${FARM_NAME}.json"
          
          if [ -f "$HISTORY_FILE" ]; then
            echo "ðŸ—‘ï¸ Clearing existing history file: $HISTORY_FILE"
            jq -n \
              --arg created_at "$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")" \
              '{
                farm_history: [],
                created_at: $created_at,
                cleared_at: (now | strftime("%Y-%m-%dT%H:%M:%S.000Z")),
                cleared_by: "manual_workflow_dispatch"
              }' > "$HISTORY_FILE"
            echo "âœ… History cleared"
          else
            echo "ðŸ“ No existing history file found"
          fi

      - name: Update farm history
        run: |
          echo "ðŸ”„ Starting farm history update..."
          
          # Ð¤ÐµÑ€Ð¼Ð° Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
          FARM_NAME="denis"
          HISTORY_FILE="data/farm_history_${FARM_NAME}.json"
          FARM_DATA_URL="https://raw.githubusercontent.com/denpistsoff/mining-monitor-web/main/data/farm_data_${FARM_NAME}.json?t=$(date +%s)"
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ data ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
          mkdir -p data
          
          # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ„ÐµÑ€Ð¼Ñ‹
          echo "ðŸ“¥ Loading farm data from: $FARM_DATA_URL"
          FARM_JSON=$(curl -f -s "$FARM_DATA_URL" || echo "{}")
          
          if [ "$FARM_JSON" = "{}" ]; then
            echo "âŒ Failed to load farm data"
            exit 0
          fi
          
          # ÐŸÐ°Ñ€ÑÐ¸Ð¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¹ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ JSON
          ACTUAL_FARM_NAME=$(echo "$FARM_JSON" | jq -r '.farm_name // ""' 2>/dev/null || echo "")
          if [ -z "$ACTUAL_FARM_NAME" ] || [ "$ACTUAL_FARM_NAME" = "null" ]; then
            ACTUAL_FARM_NAME="$FARM_NAME"
          fi
          
          echo "ðŸ·ï¸ Farm name: $ACTUAL_FARM_NAME"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ñ„ÐµÑ€Ð¼Ð° Ð¾Ð½Ð»Ð°Ð¹Ð½ (Ð¸Ñ‰ÐµÐ¼ _isOfflineData)
          if echo "$FARM_JSON" | grep -q "_isOfflineData\" *: *true"; then
            echo "âŒ Farm is offline, skipping update"
            exit 0
          fi
          
          # Ð’Ñ‹Ñ‡Ð¸ÑÐ»ÑÐµÐ¼ Ð¾Ð±Ñ‰Ð¸Ðµ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»Ð¸ Ð¸Ð· ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
          TOTAL_HASHRATE=0
          TOTAL_POWER=0
          TOTAL_ONLINE_MINERS=0
          TOTAL_PROBLEMATIC_MINERS=0
          TOTAL_MINERS=0
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÑÐµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
          CONTAINERS=$(echo "$FARM_JSON" | jq -r '.containers | keys[]' 2>/dev/null || echo "")
          
          if [ -n "$CONTAINERS" ]; then
            for CONTAINER in $CONTAINERS; do
              echo "ðŸ“¦ Processing container: $CONTAINER"
          
              CONTAINER_HASHRATE=$(echo "$FARM_JSON" | jq -r ".containers.\"$CONTAINER\".total_hashrate // 0" 2>/dev/null || echo "0")
              CONTAINER_POWER=$(echo "$FARM_JSON" | jq -r ".containers.\"$CONTAINER\".total_power // 0" 2>/dev/null || echo "0")
              CONTAINER_ONLINE=$(echo "$FARM_JSON" | jq -r ".containers.\"$CONTAINER\".online_miners // 0" 2>/dev/null || echo "0")
              CONTAINER_PROBLEMATIC=$(echo "$FARM_JSON" | jq -r ".containers.\"$CONTAINER\".problematic_count // 0" 2>/dev/null || echo "0")
              CONTAINER_TOTAL=$(echo "$FARM_JSON" | jq -r ".containers.\"$CONTAINER\".total_miners // 0" 2>/dev/null || echo "0")
          
              echo "   Hashrate: $CONTAINER_HASHRATE, Power: $CONTAINER_POWER, Online: $CONTAINER_ONLINE/$CONTAINER_TOTAL"
          
              TOTAL_HASHRATE=$(echo "$TOTAL_HASHRATE + $CONTAINER_HASHRATE" | bc -l 2>/dev/null || echo "$TOTAL_HASHRATE")
              TOTAL_POWER=$(echo "$TOTAL_POWER + $CONTAINER_POWER" | bc -l 2>/dev/null || echo "$TOTAL_POWER")
              TOTAL_ONLINE_MINERS=$(echo "$TOTAL_ONLINE_MINERS + $CONTAINER_ONLINE" | bc -l 2>/dev/null || echo "$TOTAL_ONLINE_MINERS")
              TOTAL_PROBLEMATIC_MINERS=$(echo "$TOTAL_PROBLEMATIC_MINERS + $CONTAINER_PROBLEMATIC" | bc -l 2>/dev/null || echo "$TOTAL_PROBLEMATIC_MINERS")
              TOTAL_MINERS=$(echo "$TOTAL_MINERS + $CONTAINER_TOTAL" | bc -l 2>/dev/null || echo "$TOTAL_MINERS")
            done
          else
            echo "âš ï¸ No containers found"
            exit 0
          fi
          
          echo "âœ… Farm data calculated:"
          echo "   Total Hashrate: $TOTAL_HASHRATE TH/s"
          echo "   Total Power: $TOTAL_POWER W"
          echo "   Online Miners: $TOTAL_ONLINE_MINERS/$TOTAL_MINERS"
          echo "   Problematic Miners: $TOTAL_PROBLEMATIC_MINERS"
          
          # Ð•ÑÐ»Ð¸ Ð²ÑÐµ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»Ð¸ Ð½ÑƒÐ»ÐµÐ²Ñ‹Ðµ - Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼
          if [ "$TOTAL_HASHRATE" = "0" ] && [ "$TOTAL_POWER" = "0" ] && [ "$TOTAL_ONLINE_MINERS" = "0" ]; then
            echo "âŒ All metrics are zero, farm might be offline, skipping update"
            exit 0
          fi
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð¼ÐµÑ‚ÐºÑƒ (Ð¾ÐºÑ€ÑƒÐ³Ð»ÑÐµÐ¼ Ð´Ð¾ 30 Ð¼Ð¸Ð½ÑƒÑ‚)
          CURRENT_TIME=$(date +%s)
          CURRENT_MINUTES=$(date +%M)
          if [ $CURRENT_MINUTES -lt 30 ]; then
            ROUNDED_MINUTES="00"
          else
            ROUNDED_MINUTES="30"
          fi
          
          CURRENT_HOUR=$(date +%H)
          CURRENT_DATE=$(date +%d.%m.%Y)
          
          # Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ timestamp ÐºÐ°Ðº Ð² Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ðµ (Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼ Ñ‡Ð°ÑÐ¾Ð²Ñ‹Ð¼ Ð¿Ð¾ÑÑÐ¾Ð¼)
          TIMESTAMP=$(date -u -d "@$CURRENT_TIME" +"%Y-%m-%dT%H:${ROUNDED_MINUTES}:00.000Z")
          TIME_LABEL="${CURRENT_HOUR}:${ROUNDED_MINUTES}"
          
          # Ð’Ñ‹Ñ‡Ð¸ÑÐ»ÑÐµÐ¼ Ñ‡Ð°Ñ Ð¸ Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ Ð´Ð»Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹
          HOUR=$((10#$CURRENT_HOUR))  # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð²ÐµÐ´ÑƒÑ‰Ð¸Ð¹ Ð½Ð¾Ð»ÑŒ
          MINUTE=$((10#$ROUNDED_MINUTES))
          
          # Ð’Ñ‹Ñ‡Ð¸ÑÐ»ÑÐµÐ¼ ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ (TH/s per kW)
          if [ "$TOTAL_POWER" != "0" ] && [ "$TOTAL_POWER" != "" ] && [ "$TOTAL_POWER" != "null" ]; then
            EFFICIENCY=$(echo "scale=3; $TOTAL_HASHRATE / ($TOTAL_POWER / 1000)" | bc -l 2>/dev/null || echo "0")
          else
            EFFICIENCY="0"
          fi
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¾Ð±ÑŠÐµÐºÑ‚ Ð½Ð¾Ð²Ð¾Ð¹ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð² Ñ‚Ð¾Ñ‡Ð½Ð¾ÑÑ‚Ð¸ ÐºÐ°Ðº Ð² Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ðµ
          NEW_ENTRY_JSON=$(jq -n \
            --arg timestamp "$TIMESTAMP" \
            --arg date "$CURRENT_DATE" \
            --argjson hour $HOUR \
            --argjson minute $MINUTE \
            --arg time_label "$TIME_LABEL" \
            --argjson total_hashrate "$TOTAL_HASHRATE" \
            --argjson total_power "$TOTAL_POWER" \
            --argjson online_miners "$TOTAL_ONLINE_MINERS" \
            --argjson problematic_count "$TOTAL_PROBLEMATIC_MINERS" \
            --argjson efficiency "$EFFICIENCY" \
            '{
              timestamp: $timestamp,
              date: $date,
              hour: $hour,
              minute: $minute,
              time_label: $time_label,
              total_hashrate: $total_hashrate,
              total_power: $total_power,
              online_miners: $online_miners,
              problematic_count: $problematic_count,
              efficiency: $efficiency
            }')
          
          echo "ðŸ“Š New entry created:"
          echo "$NEW_ENTRY_JSON" | jq '.'
          
          # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÑƒÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¸Ð»Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ
          if [ -f "$HISTORY_FILE" ]; then
            echo "ðŸ“– Loading existing history from $HISTORY_FILE"
            HISTORY_JSON=$(cat "$HISTORY_FILE")
          else
            echo "ðŸŽ¯ Creating NEW history file for $ACTUAL_FARM_NAME (first run)"
            HISTORY_JSON=$(jq -n \
              --arg created_at "$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")" \
              '{
                farm_history: [],
                created_at: $created_at
              }')
          fi
          
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ - Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð¸ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€
          UPDATED_HISTORY=$(echo "$HISTORY_JSON" | jq \
            --argjson new_entry "$NEW_ENTRY_JSON" \
            '.farm_history |= [$new_entry] + . |
             .farm_history |= .[0:672] |  # ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ 2 Ð½ÐµÐ´ÐµÐ»ÑÐ¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…
             .last_update = (now | strftime("%Y-%m-%dT%H:%M:%S.000Z"))')
          
          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½ÑƒÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ
          echo "$UPDATED_HISTORY" > "$HISTORY_FILE"
          echo "ðŸ’¾ History saved to $HISTORY_FILE"
          echo "ðŸ“ˆ Total entries: $(echo "$UPDATED_HISTORY" | jq '.farm_history | length')"

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/
          git diff --staged --quiet || git commit -m "ðŸ¤– Auto-update farm history $(date +%H:%M)"
          git push